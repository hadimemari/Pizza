generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ──────────────────────────────────────────
// کاربران
// ──────────────────────────────────────────

model User {
  id        String   @id @default(cuid())
  phone     String   @unique
  name      String?  // display name (computed: firstName + lastName)
  firstName String?
  lastName  String?
  role      String   @default("CUSTOMER") // CUSTOMER | ADMIN
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── اطلاعات تکمیلی ──
  email            String?
  birthDate        String?  // computed: "YYYY/MM/DD"
  birthYear        Int?
  birthMonth       Int?
  birthDay         Int?
  avatarUrl        String?

  // ── یادداشت پیش‌فرض ──
  defaultOrderNote String?

  // ── وفاداری ──
  loyaltyPoints  Int      @default(0)
  loyaltyTier    String   @default("BRONZE") // BRONZE | SILVER | GOLD | DIAMOND
  totalOrders    Int      @default(0)
  totalSpent     Int      @default(0)
  referralCode   String?  @unique
  referredById   String?
  lastOrderAt    DateTime?

  // ── تنظیمات ──
  smsOptIn         Boolean @default(true)
  preferredPayment String? // ONLINE | CASH | CARD_ON_DELIVERY

  // ── مدیریتی ──
  status    String  @default("ACTIVE") // ACTIVE | SUSPENDED | BANNED
  adminNote String?

  // ── session ──
  lastActiveAt DateTime?
  sessionExpiresAt DateTime?

  // ── روابط ──
  cart       Cart?
  orders     Order[]
  reviews    Review[]
  otpCodes   OtpCode[]
  addresses  Address[]
  favorites  FavoriteOrder[]
  // referredBy tracked via referredById (self-relation deferred)
}

// ──────────────────────────────────────────
// آدرس‌های تحویل
// ──────────────────────────────────────────

model Address {
  id            String   @id @default(cuid())
  title         String   // "خانه"، "محل کار"
  province      String   @default("تهران")
  city          String   @default("تهران")
  neighborhood  String   // محله
  street        String   // نشانی کامل
  postalCode    String?  // کد پستی ۱۰ رقمی
  latitude      Float?
  longitude     Float?
  receiverName  String?
  receiverPhone String?
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@index([userId])
}

// ──────────────────────────────────────────
// سفارش همیشگی (مورد علاقه)
// ──────────────────────────────────────────

model FavoriteOrder {
  id        String   @id @default(cuid())
  title     String   // "پیتزا جمعه‌ها"، "ناهار اداره"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  items FavoriteOrderItem[]

  @@index([userId])
}

model FavoriteOrderItem {
  id       String @id @default(cuid())
  quantity Int    @default(1)

  favoriteOrder   FavoriteOrder @relation(fields: [favoriteOrderId], references: [id], onDelete: Cascade)
  favoriteOrderId String
  product         Product       @relation(fields: [productId], references: [id])
  productId       String

  @@unique([favoriteOrderId, productId])
}

// ──────────────────────────────────────────
// OTP برای احراز هویت
// ──────────────────────────────────────────

model OtpCode {
  id        String   @id @default(cuid())
  phone     String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user   User?  @relation(fields: [userId], references: [id])
  userId String?

  @@index([phone, code])
}

// ──────────────────────────────────────────
// دسته‌بندی و محصولات
// ──────────────────────────────────────────

model Category {
  id       String    @id @default(cuid())
  name     String
  slug     String    @unique
  icon     String
  sortOrder Int      @default(0)
  products Product[]
}

model Product {
  id          String   @id @default(cuid())
  name        String
  price       Int      // قیمت به تومان
  description String
  image       String
  ingredients String   // JSON array as string
  isAvailable Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String

  reviews            Review[]
  cartItems          CartItem[]
  orderItems         OrderItem[]
  favoriteOrderItems FavoriteOrderItem[]

  @@index([categoryId])
}

// ──────────────────────────────────────────
// نظرات
// ──────────────────────────────────────────

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5
  comment   String
  createdAt DateTime @default(now())

  user      User    @relation(fields: [userId], references: [id])
  userId    String
  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@index([productId])
}

// ──────────────────────────────────────────
// سبد خرید
// ──────────────────────────────────────────

model Cart {
  id        String     @id @default(cuid())
  user      User       @relation(fields: [userId], references: [id])
  userId    String     @unique
  items     CartItem[]
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String  @id @default(cuid())
  quantity  Int     @default(1)

  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId    String
  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@unique([cartId, productId])
}

// ──────────────────────────────────────────
// سفارشات
// ──────────────────────────────────────────

model Order {
  id          String   @id @default(cuid())
  orderNumber Int      @unique
  status      String   @default("PENDING") // PENDING | CONFIRMED | PREPARING | DELIVERED | CANCELLED
  totalAmount Int      // مبلغ کل به تومان (شامل مالیات و ارسال)
  subtotal    Int      @default(0) // جمع غذاها
  deliveryFee Int      @default(0) // هزینه ارسال
  tax         Int      @default(0) // مالیات ارزش افزوده
  note        String?  // یادداشت مشتری
  addressId   String?  // آدرس تحویل
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User        @relation(fields: [userId], references: [id])
  userId  String
  items   OrderItem[]
  payment Payment?

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id        String @id @default(cuid())
  quantity  Int
  unitPrice Int    // قیمت واحد در لحظه سفارش

  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId   String
  product   Product @relation(fields: [productId], references: [id])
  productId String
}

// ──────────────────────────────────────────
// پرداخت (آماده‌سازی - بدون اتصال واقعی)
// ──────────────────────────────────────────

model Payment {
  id            String   @id @default(cuid())
  amount        Int      // مبلغ به تومان
  status        String   @default("PENDING") // PENDING | SUCCESS | FAILED
  gateway       String?  // zarinpal | idpay | ...
  transactionId String?  // شناسه تراکنش از درگاه
  refId         String?  // شماره مرجع
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  order   Order  @relation(fields: [orderId], references: [id])
  orderId String @unique
}
